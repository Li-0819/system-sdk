<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iris.mapper.ISysBannerMapper">

    <sql id="bannerCommonColumn">
        sb.id, sb.banner_type, sc.name codeName, sb.banner_name, sb.img_url, sb.link_url, sb.is_enabled, sb.remark,
        sb.is_deleted, sb.created_by, sb.created_time, sb.modified_by, sb.modified_time
    </sql>

    <resultMap id="sysBannerVO" type="com.iris.model.vo.system.SysBannerVO">
        <id column="id" property="id"/>
        <result column="banner_type" property="bannerType"/>
        <result column="banner_name" property="bannerName"/>
        <result column="img_url" property="imgUrl"/>
        <result column="link_url" property="linkUrl"/>
        <result column="is_enabled" property="isEnabled"/>
        <result column="remark" property="remark"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="created_by" property="createdBy"/>
        <result column="created_time" property="createdTime"/>
        <result column="modified_by" property="modifiedBy"/>
        <result column="modified_time" property="modifiedTime"/>

        <collection property="attachInfoVOS" ofType="com.iris.model.vo.system.SysAttachInfoVO">
            <id column="sai_id" property="id" />
            <result column="ref_id" property="refId"/>
            <result column="attach_type" property="attachType"/>
            <result column="attachTypeName" property="attachTypeName"/>
            <result column="attach_name" property="attachName"/>
            <result column="path" property="path"/>
            <result column="transform_path" property="transformPath"/>
            <result column="extension" property="extension"/>
            <result column="extra_info" property="extraInfo"/>
            <result column="sequence" property="sequence"/>
        </collection>
    </resultMap>

    <select id="getList" resultMap="sysBannerVO">

        select list.id, list.banner_type, list.codeName, list.banner_name, list.img_url, list.link_url, list.is_enabled, list.remark,
                list.is_deleted, list.created_by, list.created_time, list.modified_by, list.modified_time,
                list.sai_id, list.ref_id, list.attach_type, list.attach_name, list.path, list.transform_path, list.extra_info,
                list.sequence, list.sai_isDeleted
        from(
            select sai.id sai_id, sai.ref_id, sai.attach_type, sc2.name attachTypeName, sai.attach_name, sai.path, sai.transform_path,
                    sai.extra_info, sai.sequence, sai.is_deleted sai_isDeleted,<include refid="bannerCommonColumn"></include>
            from sys_banner sb
                left join sys_code sc on sc.is_deleted = 0 and sc.value = sb.banner_type
                left join sys_attach_info sai on sai.is_deleted = 0 and sb.id = sai.ref_id
                left join sys_code sc2 on sc2.is_deleted = 0 and  sc2.value = sai.attach_type
        ) list
        <where>
            list.is_deleted = 0
            <if test="sysBannerListDTO.isEnabled != null">
                and list.is_enabled = #{sysBannerListDTO.isEnabled}
            </if>
            <if test="sysBannerListDTO.bannerType != null and sysBannerListDTO.bannerType != ''">
                and list.banner_type = #{sysBannerListDTO.bannerType}
            </if>
            <if test="sysBannerListDTO.bannerName != null and sysBannerListDTO.bannerName != ''">
                and list.banner_name like concat('%',#{sysBannerListDTO.bannerName},'%')
            </if>
            <if test="sysBannerListDTO.startTime != null and sysBannerListDTO.startTime != ''">
                and list.created_time &gt;= #{sysBannerListDTO.startTime}
            </if>
            <if test="sysBannerListDTO.endTime != null and sysBannerListDTO.endTime != ''">
                and list.created_time &gt;= #{sysBannerListDTO.endTime}
            </if>
        </where>
        order by list.created_time desc
    </select>

    <select id="getDetail" resultType="com.iris.model.vo.system.SysBannerVO">

        select <include refid="bannerCommonColumn"></include>
        from sys_banner sb
            left join sys_code sc on sc.value = sb.banner_type and sc.is_deleted = 0
        where sb.id = #{id} and sb.is_deleted = 0
    </select>
</mapper>
