<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.iris.mapper.ISysUsersMapper">

    <resultMap id="usersDetailVO" type="com.iris.model.vo.system.UsersDetailVO">
        <id column="id" jdbcType="VARCHAR" property="id"></id>
        <result column="login_name" jdbcType="VARCHAR" property="loginName"></result>
        <result column="real_name" jdbcType="VARCHAR" property="realName"></result>
        <result column="gender" jdbcType="VARCHAR" property="gender"></result>
        <result column="genderName" jdbcType="VARCHAR" property="genderName"></result>
        <result column="phone_number" jdbcType="VARCHAR" property="phoneNumber"></result>
        <result column="remark" jdbcType="VARCHAR" property="remark"></result>
        <result column="is_deleted" jdbcType="VARCHAR" property="isDeleted"></result>
        <result column="is_locked" jdbcType="INTEGER" property="isLocked"></result>
        <result column="created_by" jdbcType="TIMESTAMP" property="createdBy"/>
        <result column="created_time" jdbcType="TIMESTAMP" property="createdTime"/>
        <result column="modified_by" jdbcType="TIMESTAMP" property="modifiedBy"/>
        <result column="modified_time" jdbcType="TIMESTAMP" property="modifiedTime"/>

        <collection property="rolesBaseVOS" ofType="com.iris.model.vo.system.RolesBaseVO">
            <id column="sr_id" jdbcType="VARCHAR" property="id"></id>
            <id column="sr_name" jdbcType="VARCHAR" property="name"></id>
            <id column="sr_code" jdbcType="VARCHAR" property="code"></id>
            <id column="sr_type" jdbcType="VARCHAR" property="type"></id>
            <id column="sc_name" jdbcType="VARCHAR" property="typeName"></id>
        </collection>

        <collection property="positionBaseVOS" ofType="com.iris.model.vo.system.PositionBaseVO">
            <id column="sp_id" jdbcType="VARCHAR" property="id"></id>
            <id column="organizations_id" jdbcType="VARCHAR" property="organizationsId"></id>
            <id column="position_name" jdbcType="VARCHAR" property="positionName"></id>
        </collection>
    </resultMap>

    <select id="getList" resultType="com.iris.model.vo.system.UsersListVO">

        select list.id, list.login_name, list.real_name, list.gender, list.genderName, list.phone_number, list.remark, list.is_locked, list.is_deleted,
        list.created_by, list.created_time, list.modified_by, list.modified_time, group_concat(list.sr_name) roleNameJoin
        from (
        select su.id, su.login_name, su.real_name, su.gender, sc1.name genderName, su.phone_number, su.remark, su.is_locked,
        su.is_deleted, su.created_by, su.created_time, su.modified_by, su.modified_time, sr.name sr_name
        from sys_users su
        left join sys_user_in_role suir on suir.is_deleted = 0 and su.id = suir.user_id
        left join sys_roles sr on sr.is_deleted = 0 and sr.id = suir.role_id
        left join sys_code sc on sc.is_deleted = 0 and sr.type = sc.value
        left join sys_code sc1 on sc1.is_deleted = 0 and su.gender = sc1.value
        ) list
        <where>
            list.is_deleted = 0 and list.login_name != 'admin'
            <if test="userListDTO.loginName != null and userListDTO.loginName != ''">
                and list.login_name = #{userListDTO.loginName}
            </if>
            <if test="userListDTO.realName != null and userListDTO.realName != ''">
                and list.real_name like concat('%',#{userListDTO.realName},'%')
            </if>
            <if test="userListDTO.isLocked != null">
                and list.is_locked = #{userListDTO.isLocked}
            </if>
            <if test="userListDTO.startTime != null and userListDTO.startTime != ''">
                and list.created_time &gt;= #{userListDTO.startTime}
            </if>
            <if test="userListDTO.endTime != null and userListDTO.endTime != ''">
                and list.created_time &lt;= #{userListDTO.endTime}
            </if>
        </where>
        group by list.id
        order by list.created_time desc
    </select>

    <select id="getDetail" resultMap="usersDetailVO">

        select su.id, su.login_name, su.real_name, su.gender, sc1.name genderName, su.phone_number, su.remark, su.is_locked, su.is_deleted, su.created_by,
               su.created_time, su.modified_by, su.modified_time, sr.id sr_id, sr.name sr_name, sr.code sr_code, sr.type sr_type, sc.name sc_name,
               sp.id sp_id, sp.organizations_id, sp.position_name
        from sys_users su
                 left join sys_user_in_role suir on suir.is_deleted = 0 and su.id = suir.user_id
                 left join sys_roles sr on sr.is_deleted = 0 and sr.id = suir.role_id
                 left join sys_code sc on sc.is_deleted = 0 and sr.type = sc.value
                 left join sys_code sc1 on sc1.is_deleted = 0 and su.gender = sc1.value
                 left join sys_user_in_position suip on suip.is_deleted = 0 and su.id = suip.user_id
                 left join sys_position sp on sp.is_deleted = 0 and sp.id = suip.position_id
        where su.id = #{id} and su.is_deleted = 0 and su.login_name != 'admin'
    </select>
</mapper>
